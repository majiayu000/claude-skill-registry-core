name: Build Search Index

on:
  # Manual trigger
  workflow_dispatch:

  # Run when registry or site sources change
  push:
    branches: [main]
    paths:
      - 'registry.json'
      - 'scripts/build_search_index.py'
      - 'docs/**'
      - '.github/workflows/build-index.yml'

permissions:
  pages: write
  id-token: write
  actions: read

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check data repo config for raw count
        id: datacfg
        env:
          REGISTRY_DATA_REPO: ${{ vars.REGISTRY_DATA_REPO }}
          DATA_REPO_TOKEN: ${{ secrets.DATA_REPO_TOKEN }}
        run: |
          if [ -z "$REGISTRY_DATA_REPO" ] || [ -z "$DATA_REPO_TOKEN" ]; then
            echo "::warning::Missing REGISTRY_DATA_REPO or DATA_REPO_TOKEN. raw_skill_count may fallback."
            echo "ready=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "ready=true" >> "$GITHUB_OUTPUT"

      - name: Checkout data repo to ./skills (raw count source)
        if: steps.datacfg.outputs.ready == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.REGISTRY_DATA_REPO }}
          token: ${{ secrets.DATA_REPO_TOKEN }}
          path: skills
          fetch-depth: 1

      - name: Download latest security report
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const workflow_id = 'sync-data.yml';
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              branch: 'main',
              status: 'success',
              per_page: 1
            });
            if (!runs.data.workflow_runs.length) {
              core.warning('No successful sync-data runs found.');
              return;
            }
            const run_id = runs.data.workflow_runs[0].id;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            const artifact = artifacts.data.artifacts.find(a => a.name === 'security-report');
            if (!artifact) {
              core.warning('No security-report artifact found.');
              return;
            }
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: artifact.id,
              archive_format: 'zip'
            });
            const fs = require('fs');
            const path = require('path');
            const zipPath = path.join(process.env.GITHUB_WORKSPACE, 'security-report.zip');
            fs.writeFileSync(zipPath, Buffer.from(download.data));

      - name: Extract security report
        run: |
          unzip -o security-report.zip -d docs || true
          ls -la docs/security-report.json || true

      - name: Build search index
        run: |
          echo "Building search index from registry.json (deduplicated)..."
          python scripts/build_search_index.py --use-registry --skills-dir skills --registry registry.json --output docs

          echo ""
          echo "Index files generated:"
          ls -la docs/
          ls -la docs/categories/ || true

          echo ""
          echo "Index sizes:"
          du -sh docs/*.json docs/*.gz 2>/dev/null || true

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

  deploy-pages:
    needs: build-index
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
